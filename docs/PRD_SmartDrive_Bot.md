# PRD โ CarQuery AI Bot

> **Telegram-ะฑะพั ะดะปั ะฐะฒัะพะดะธะปะตัะฐ ั ะธะฝัะตะณัะฐัะธะตะน AmoCRM ะธ AI-ะผะพะดัะปะตะผ OpenAI**

| ะะพะปะต           | ะะฝะฐัะตะฝะธะต                                      |
| -------------- | --------------------------------------------- |
| **ะัะพะตะบั**     | CarQuery AI Bot                               |
| **ะะตััะธั PRD** | 1.0                                           |
| **ะะฐัะฐ**       | 2025-02-09                                    |
| **ะกัะตะบ**       | Python 3.12, aiogram 3.x, PostgreSQL, Redis, Docker |
| **CRM**        | AmoCRM (REST API v4)                          |
| **AI**         | OpenAI API (gpt-4o-mini / gpt-4o fallback)   |

---

## 1. ะฆะตะปะธ ะธ ะทะฐะดะฐัะธ ะฟัะพะตะบัะฐ

### 1.1 ะะธะทะฝะตั-ัะตะปะธ

- ะะฒัะพะผะฐัะธะทะธัะพะฒะฐัั ะพะฑัะฐะฑะพัะบั ะฟะตัะฒะธัะฝัั ะพะฑัะฐัะตะฝะธะน ะบะปะธะตะฝัะพะฒ (ะดะพ 80 % ัะธะฟะพะฒัั ะทะฐะฟัะพัะพะฒ ะฑะตะท ััะฐััะธั ะผะตะฝะตะดะถะตัะฐ).
- ะคะพัะผะธัะพะฒะฐัั ะบะฒะฐะปะธัะธัะธัะพะฒะฐะฝะฝัะน ะปะธะด ั ะทะฐะฟะพะปะฝะตะฝะฝัะผะธ ะฟะพะปัะผะธ ะธ ะฟะตัะตะดะฐะฒะฐัั ะตะณะพ ะฒ AmoCRM ะทะฐ โค 3 ัะตะบัะฝะดั ะฟะพัะปะต ะทะฐะฒะตััะตะฝะธั ะดะธะฐะปะพะณะฐ.
- ะกะฝะธะทะธัั ะฒัะตะผั ะฟะตัะฒะพะณะพ ะพัะฒะตัะฐ ะบะปะธะตะฝัั ะดะพ < 5 ัะตะบัะฝะด (24/7).
- ะะพะฒััะธัั ะบะพะฝะฒะตััะธั ยซะพะฑัะฐัะตะฝะธะต โ ัะดะตะปะบะฐยป ะทะฐ ัััั ัะฑะพัะฐ ััััะบัััะธัะพะฒะฐะฝะฝัั ะดะฐะฝะฝัั ะดะพ ะบะพะฝัะฐะบัะฐ ั ะผะตะฝะตะดะถะตัะพะผ.

### 1.2 ะะพะปัะทะพะฒะฐัะตะปััะบะฐั ะฟัะพะฑะปะตะผะฐ

ะะปะธะตะฝั ะฟะธัะตั ะฒ Telegram ะธ ะพะถะธะดะฐะตั ะผะณะฝะพะฒะตะฝะฝะพะน ัะตะฐะบัะธะธ. ะะตะฝะตะดะถะตัั ะฝะต ะผะพะณัั ะพัะฒะตัะฐัั ะบััะณะปะพัััะพัะฝะพ, ะฐ ะฟัะธ ัััะฝะพะน ะพะฑัะฐะฑะพัะบะต ัะตัััััั ะดะฐะฝะฝัะต ะธ ะบะพะฝัะตะบัั ะพะฑัะฐัะตะฝะธั. ะะพั ะทะฐะบััะฒะฐะตั ััะพั ัะฐะทััะฒ: ัะพะฑะธัะฐะตั ะฟะตัะฒะธัะฝัั ะธะฝัะพัะผะฐัะธั, ะบะฒะฐะปะธัะธัะธััะตั ะฟะพััะตะฑะฝะพััั, ะฟะตัะตะดะฐัั ะณะพัััะธะน ะปะธะด ะผะตะฝะตะดะถะตัั ั ะฟะพะปะฝัะผ ะบะพะฝัะตะบััะพะผ.

### 1.3 ะะปััะตะฒัะต ะผะตััะธะบะธ (KPI)

| ะะตััะธะบะฐ                             | ะฆะตะปะตะฒะพะต ะทะฝะฐัะตะฝะธะต         |
| ----------------------------------- | ------------------------ |
| ะัะตะผั ะพัะฒะตัะฐ ะฑะพัะฐ                   | < 5 ัะตะบ                  |
| ะะพะฝะฒะตััะธั start โ ะทะฐะฒะตัััะฝะฝัะน ะพะฟัะพั | โฅ 60 %                   |
| ะะพััะตะบัะฝะพััั ะฟะตัะตะดะฐัะธ ะฒ CRM         | 100 % (ะฑะตะท ะฟะพัะตัั ะฟะพะปะตะน) |
| ะัะพัะตะฝั ะดัะฑะปะตะน ะบะพะฝัะฐะบัะพะฒ            | 0 %                      |
| Uptime ะฑะพัะฐ                         | 99.5 %+                  |

---

## 2. ะฆะตะปะตะฒะฐั ะฐัะดะธัะพัะธั

| ะกะตะณะผะตะฝั                 | ะะฟะธัะฐะฝะธะต                                                  |
| ----------------------- | --------------------------------------------------------- |
| **ะัะพะดะฐะฒัั ะฐะฒัะพ**       | ะฅะพััั ะฑััััะพ ะพัะตะฝะธัั ะธ ะฟัะพะดะฐัั ัะฒะพะน ะฐะฒัะพะผะพะฑะธะปั            |
| **ะะพะบัะฟะฐัะตะปะธ ะฐะฒัะพ**     | ะััั ะฐะฒัะพะผะพะฑะธะปั ั ะพะฟัะตะดะตะปัะฝะฝัะผะธ ะฟะฐัะฐะผะตััะฐะผะธ               |
| **ะะปะธะตะฝัั ะฝะฐ ะฟะพะดะฑะพั**   | ะฅะพััั, ััะพะฑั ะธะผ ะฟะพะดะพะฑัะฐะปะธ ะฐะฒัะพะผะพะฑะธะปั ะฟะพะด ะทะฐะฟัะพั           |
| **ะะปะธะตะฝัั ะฝะฐ ะฟัะพะฒะตัะบั** | ะฅะพััั ะฟัะพะฒะตัะธัั ัะตััะพััะพัะฝะธะต ะธะปะธ ััะธะดะธัะตัะบัั ัะธััะพัั ะฐะฒัะพ |
| **ะฎัะธะดะธัะตัะบะธะต ะฒะพะฟัะพัั** | ะะตัะตะพัะพัะผะปะตะฝะธะต, ัััะฐัะพะฒะฐะฝะธะต, ัะฟะพัั, ะดะพะบัะผะตะฝัั             |

---

## 3. ะคัะฝะบัะธะพะฝะฐะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั

### 3.1 ะะฐััะฐ ััะตะฝะฐัะธะตะฒ (ะดะตัะตะฒะพ ะดะธะฐะปะพะณะฐ)

```
/start
 โ
 โโโ ๐ ะัะธะฒะตัััะฒะตะฝะฝะพะต ัะพะพะฑัะตะฝะธะต + ะพะฟะธัะฐะฝะธะต ะฒะพะทะผะพะถะฝะพััะตะน
 โ
 โโโ ๐ ะะปะฐะฒะฝะพะต ะผะตะฝั (InlineKeyboard)
      โ
      โโโ ๐ต ะัะพะดะฐัั ะฐะฒัะพ
      โ    โโโ ะจะฐะณ 1: ะะฐัะบะฐ ะธ ะผะพะดะตะปั (ัะตะบััะพะฒัะน ะฒะฒะพะด)
      โ    โโโ ะจะฐะณ 2: ะะพะด ะฒัะฟััะบะฐ (InlineKeyboard: ะดะธะฐะฟะฐะทะพะฝั ะธะปะธ ัะตะบัั)
      โ    โโโ ะจะฐะณ 3: ะัะพะฑะตะณ (ัะตะบััะพะฒัะน ะฒะฒะพะด, ะฒะฐะปะธะดะฐัะธั ัะธัะปะฐ)
      โ    โโโ ะจะฐะณ 4: ะะตะปะฐะตะผะฐั ัะตะฝะฐ / ยซะะฐ ะฒะฐัะต ััะผะพััะตะฝะธะตยป (ัะตะบัั / ะบะฝะพะฟะบะฐ)
      โ    โโโ ะจะฐะณ 5: ะคะพัะพ ะฐะฒัะพ (ะพะฟัะธะพะฝะฐะปัะฝะพ, MediaGroup)
      โ    โโโ ะจะฐะณ 6: ะะผั (ัะตะบััะพะฒัะน ะฒะฒะพะด)
      โ    โโโ ะจะฐะณ 7: ะขะตะปะตัะพะฝ (ะบะฝะพะฟะบะฐ ยซะะพะดะตะปะธัััั ะบะพะฝัะฐะบัะพะผยป / ัะตะบัั)
      โ    โโโ ะจะฐะณ 8: ะะพะผะผะตะฝัะฐัะธะน (ัะฒะพะฑะพะดะฝัะน ัะตะบัั / ยซะัะพะฟัััะธััยป)
      โ    โโโ โ ะะพะดัะฒะตัะถะดะตะฝะธะต โ ะัะฟัะฐะฒะบะฐ ะฒ CRM
      โ
      โโโ ๐ข ะัะฟะธัั ะฐะฒัะพ
      โ    โโโ ะจะฐะณ 1: ะะฐะบัั ะผะฐัะบั/ะผะพะดะตะปั ะธัะตัะต? (ัะตะบัั)
      โ    โโโ ะจะฐะณ 2: ะัะดะถะตั (InlineKeyboard: ะดะธะฐะฟะฐะทะพะฝั)
      โ    โ         โข ะดะพ 500 000 โฝ
      โ    โ         โข 500 000 โ 1 000 000 โฝ
      โ    โ         โข 1 000 000 โ 2 000 000 โฝ
      โ    โ         โข 2 000 000 โ 3 000 000 โฝ
      โ    โ         โข ะพั 3 000 000 โฝ
      โ    โ         โข ะฃะบะฐะทะฐัั ัะฒะพะน
      โ    โโโ ะจะฐะณ 3: ะะพะด ะฒัะฟััะบะฐ ะพั (InlineKeyboard / ัะตะบัั)
      โ    โโโ ะจะฐะณ 4: ะะพัะพะฑะบะฐ ะฟะตัะตะดะฐั (InlineKeyboard: ะะะะ / ะะะะ / ะะพะฑะพั / ะะฐัะธะฐัะพั / ะัะฑะฐั)
      โ    โโโ ะจะฐะณ 5: ะัะธะฒะพะด (InlineKeyboard: ะะตัะตะดะฝะธะน / ะะฐะดะฝะธะน / ะะพะปะฝัะน / ะัะฑะพะน)
      โ    โโโ ะจะฐะณ 6: ะะผั
      โ    โโโ ะจะฐะณ 7: ะขะตะปะตัะพะฝ
      โ    โโโ ะจะฐะณ 8: ะะพะฟะพะปะฝะธัะตะปัะฝัะต ะฟะพะถะตะปะฐะฝะธั (ัะฒะพะฑะพะดะฝัะน ัะตะบัั / ยซะัะพะฟัััะธััยป)
      โ    โโโ โ ะะพะดัะฒะตัะถะดะตะฝะธะต โ ะัะฟัะฐะฒะบะฐ ะฒ CRM
      โ
      โโโ ๐ก ะะพะดะฑะพั ะฐะฒัะพ
      โ    โโโ ะจะฐะณ 1: ะะปั ะบะฐะบะธั ัะตะปะตะน? (InlineKeyboard)
      โ    โ         โข ะะปั ะณะพัะพะดะฐ
      โ    โ         โข ะะปั ัะตะผัะธ
      โ    โ         โข ะะปั ะฑะธะทะฝะตัะฐ
      โ    โ         โข ะะปั ะฑะตะทะดะพัะพะถัั
      โ    โ         โข ะััะณะพะต (ัะตะบัั)
      โ    โโโ ะจะฐะณ 2: ะัะดะถะตั (InlineKeyboard: ัะต ะถะต ะดะธะฐะฟะฐะทะพะฝั)
      โ    โโโ ะจะฐะณ 3: ะัะตะดะฟะพััะตะฝะธั ะฟะพ ะผะฐัะบะต (ัะตะบัั / ยซะะตะท ัะฐะทะฝะธััยป)
      โ    โโโ ะจะฐะณ 4: ะขะธะฟ ะบัะทะพะฒะฐ (InlineKeyboard: ะกะตะดะฐะฝ / ะัะพััะพะฒะตั / ะะฝะตะดะพัะพะถะฝะธะบ / ะฅัััะฑะตะบ / ะฃะฝะธะฒะตััะฐะป / ะัะฑะพะน)
      โ    โโโ ะจะฐะณ 5: ะะผั
      โ    โโโ ะจะฐะณ 6: ะขะตะปะตัะพะฝ
      โ    โโโ ะจะฐะณ 7: ะะพะผะผะตะฝัะฐัะธะน / ยซะัะพะฟัััะธััยป
      โ    โโโ โ ะะพะดัะฒะตัะถะดะตะฝะธะต โ ะัะฟัะฐะฒะบะฐ ะฒ CRM
      โ
      โโโ ๐ ะัะพะฒะตัะบะฐ ะฐะฒัะพ
      โ    โโโ ะจะฐะณ 1: ะขะธะฟ ะฟัะพะฒะตัะบะธ (InlineKeyboard)
      โ    โ         โข ะขะตัะฝะธัะตัะบะฐั ะดะธะฐะณะฝะพััะธะบะฐ
      โ    โ         โข ะฎัะธะดะธัะตัะบะฐั ะฟัะพะฒะตัะบะฐ
      โ    โ         โข ะะพะผะฟะปะตะบัะฝะฐั ะฟัะพะฒะตัะบะฐ
      โ    โโโ ะจะฐะณ 2: ะะฐัะบะฐ ะธ ะผะพะดะตะปั (ัะตะบัั)
      โ    โโโ ะจะฐะณ 3: VIN / ะะพัะฝะพะผะตั (ัะตะบัั, ะพะฟัะธะพะฝะฐะปัะฝะพ)
      โ    โโโ ะจะฐะณ 4: ะะผั
      โ    โโโ ะจะฐะณ 5: ะขะตะปะตัะพะฝ
      โ    โโโ ะจะฐะณ 6: ะะพะผะผะตะฝัะฐัะธะน / ยซะัะพะฟัััะธััยป
      โ    โโโ โ ะะพะดัะฒะตัะถะดะตะฝะธะต โ ะัะฟัะฐะฒะบะฐ ะฒ CRM
      โ
      โโโ ๐ด ะฎัะธะดะธัะตัะบะฐั ะฟะพะผะพัั
      โ    โโโ ะจะฐะณ 1: ะขะธะฟ ะฒะพะฟัะพัะฐ (InlineKeyboard)
      โ    โ         โข ะะตัะตะพัะพัะผะปะตะฝะธะต / ะฟะพััะฐะฝะพะฒะบะฐ ะฝะฐ ัััั
      โ    โ         โข ะกััะฐัะพะฒะฐะฝะธะต (ะะกะะะ / ะะะกะะ)
      โ    โ         โข ะะพะทะฒัะฐั ะฐะฒัะพ / ัะฟะพั ั ะฟัะพะดะฐะฒัะพะผ
      โ    โ         โข ะััะณะพะต (ัะตะบัั)
      โ    โโโ ะจะฐะณ 2: ะัะฐัะบะพะต ะพะฟะธัะฐะฝะธะต ัะธััะฐัะธะธ (ัะฒะพะฑะพะดะฝัะน ัะตะบัั)
      โ    โโโ ะจะฐะณ 3: ะะผั
      โ    โโโ ะจะฐะณ 4: ะขะตะปะตัะพะฝ
      โ    โโโ ะจะฐะณ 5: ะะพะผะผะตะฝัะฐัะธะน / ยซะัะพะฟัััะธััยป
      โ    โโโ โ ะะพะดัะฒะตัะถะดะตะฝะธะต โ ะัะฟัะฐะฒะบะฐ ะฒ CRM
      โ
      โโโ ๐ฌ ะกะฒะพะฑะพะดะฝัะน ะฒะพะฟัะพั โ AI-ะผะพะดัะปั OpenAI
           โโโ ะะฑัะฐะฑะพัะบะฐ ัะตะบััะฐ ัะตัะตะท OpenAI API
           โโโ ะะปะฐััะธัะธะบะฐัะธั ะฝะฐะผะตัะตะฝะธั (intent)
           โโโ ะัะปะธ intent ะพะฟัะตะดะตะปัะฝ โ ะฟัะตะดะปะพะถะธัั ะฟะตัะตะนัะธ ะฒ ัะพะพัะฒะตัััะฒััััั ะฒะตัะบั
           โโโ ะัะปะธ intent ะฝะต ะพะฟัะตะดะตะปัะฝ โ ะฟัะตะดะปะพะถะธัั ัะฒัะทะฐัััั ั ะผะตะฝะตะดะถะตัะพะผ
```

### 3.2 ะะพะปั, ะฟะตัะตะดะฐะฒะฐะตะผัะต ะฒ AmoCRM

#### ะะพะฝัะฐะบั (Contact)

| ะะพะปะต AmoCRM       | ะััะพัะฝะธะบ ะดะฐะฝะฝัั                      | ะขะธะฟ   | ะะฑัะทะฐัะตะปัะฝะพะต |
| ----------------- | ------------------------------------ | ----- | ------------ |
| ะะผั               | ะะฒะพะด ะฟะพะปัะทะพะฒะฐัะตะปั                    | `str` | โ           |
| ะขะตะปะตัะพะฝ           | ะะฝะพะฟะบะฐ ยซะะพะดะตะปะธัััั ะบะพะฝัะฐะบัะพะผยป / ะฒะฒะพะด | `str` | โ           |
| Telegram ID       | `message.from_user.id`               | `int` | โ           |
| Telegram Username | `message.from_user.username`         | `str` | โ           |

#### ะกะดะตะปะบะฐ (Lead)

| ะะพะปะต AmoCRM     | ะััะพัะฝะธะบ ะดะฐะฝะฝัั                                  | ะขะธะฟ    | ะะฑัะทะฐัะตะปัะฝะพะต     |
| --------------- | ------------------------------------------------ | ------ | ---------------- |
| ะะฐะทะฒะฐะฝะธะต ัะดะตะปะบะธ | ะะฒัะพ-ะณะตะฝะตัะฐัะธั: `{ะขะธะฟ ััะปัะณะธ} โ {ะะฐัะบะฐ} โ {ะะผั}` | `str`  | โ               |
| ะขะธะฟ ััะปัะณะธ      | ะัะฑะพั ะธะท ะผะตะฝั                                    | `enum` | โ               |
| ะะฐัะบะฐ / ะะพะดะตะปั  | ะะฒะพะด ะฟะพะปัะทะพะฒะฐัะตะปั                                | `str`  | ะะฐะฒะธัะธั ะพั ะฒะตัะบะธ |
| ะะพะด ะฒัะฟััะบะฐ     | ะะฒะพะด / ะฒัะฑะพั                                     | `str`  | โ               |
| ะัะดะถะตั          | ะัะฑะพั ะธะท ะดะธะฐะฟะฐะทะพะฝะพะฒ / ะฒะฒะพะด                       | `str`  | โ               |
| ะัะพะฑะตะณ          | ะะฒะพะด                                             | `str`  | โ               |
| ะขะธะฟ ะบัะทะพะฒะฐ      | ะัะฑะพั ะธะท InlineKeyboard                          | `str`  | โ               |
| ะะพัะพะฑะบะฐ ะฟะตัะตะดะฐั | ะัะฑะพั ะธะท InlineKeyboard                          | `str`  | โ               |
| ะัะธะฒะพะด          | ะัะฑะพั ะธะท InlineKeyboard                          | `str`  | โ               |
| VIN / ะะพัะฝะพะผะตั  | ะะฒะพะด                                             | `str`  | โ               |
| ะขะธะฟ ะฟัะพะฒะตัะบะธ    | ะัะฑะพั                                            | `str`  | โ               |
| ะััะพัะฝะธะบ        | ะะพะฝััะฐะฝัะฐ: `Telegram Bot`                        | `str`  | โ               |

#### ะัะธะผะตัะฐะฝะธะต (Note)

| ะกะพะดะตัะถะฐะฝะธะต                    | ะคะพัะผะฐั                                   |
| ----------------------------- | ---------------------------------------- |
| ะัะต ะพัะฒะตัั ะฟะพะปัะทะพะฒะฐัะตะปั       | ะกัััะบัััะธัะพะฒะฐะฝะฝัะน ัะตะบัั (ะฒะพะฟัะพั โ ะพัะฒะตั) |
| ะกะฒะพะฑะพะดะฝัะน ัะตะบัั / ะบะพะผะผะตะฝัะฐัะธะน | ยซะะฐะบ ะตัััยป                               |
| ะคะพัะพ (ะตัะปะธ ะทะฐะณััะถะตะฝั)         | ะกััะปะบะธ ะฝะฐ ัะฐะนะปั ะฒ Telegram / S3          |
| ะะตัะฐะดะฐะฝะฝัะต                    | ะะฐัะฐ ะพะฑัะฐัะตะฝะธั, Telegram ID, username    |

#### ะะพัะพะฝะบะฐ ะธ ััะฐะฟ

| ะะฐัะฐะผะตัั      | ะะฝะฐัะตะฝะธะต                                                           |
| ------------- | ------------------------------------------------------------------ |
| ะะพัะพะฝะบะฐ       | ะะฐัััะฐะธะฒะฐะตะผะฐั (ะบะพะฝัะธะณ `PIPELINE_ID`)                               |
| ะญัะฐะฟ          | ยซะะตัะฒะธัะฝะพะต ะพะฑัะฐัะตะฝะธะตยป (ะบะพะฝัะธะณ `STATUS_ID`)                         |
| ะัะฒะตัััะฒะตะฝะฝัะน | ะะพ ัะผะพะปัะฐะฝะธั (ะบะพะฝัะธะณ `RESPONSIBLE_USER_ID`) ะธะปะธ ะฐะฒัะพ-ัะฐัะฟัะตะดะตะปะตะฝะธะต |

### 3.3 ะขะตะบััั ะธ ะบะฝะพะฟะบะธ

#### ะัะธะฒะตัััะฒะตะฝะฝะพะต ัะพะพะฑัะตะฝะธะต (`/start`)

```
๐ ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั ะฒ CarQuery AI!

ะั ะฟะพะผะพะณะฐะตะผ ั ะฟะพะบัะฟะบะพะน, ะฟัะพะดะฐะถะตะน, ะฟะพะดะฑะพัะพะผ
ะธ ะฟัะพะฒะตัะบะพะน ะฐะฒัะพะผะพะฑะธะปะตะน, ะฐ ัะฐะบะถะต ั ััะธะดะธัะตัะบะธะผะธ ะฒะพะฟัะพัะฐะผะธ.

ะัะฑะตัะธัะต, ััะพ ะฒะฐั ะธะฝัะตัะตััะตั:
```

**ะะฝะพะฟะบะธ ะณะปะฐะฒะฝะพะณะพ ะผะตะฝั (InlineKeyboard, 2 ััะพะปะฑัะฐ):**

| ะะฝะพะฟะบะฐ                | callback_data      |
| --------------------- | ------------------ |
| ๐ ะัะพะดะฐัั ะฐะฒัะพ       | `service:sell`     |
| ๐ ะัะฟะธัั ะฐะฒัะพ        | `service:buy`      |
| ๐ฏ ะะพะดะฑะพั ะฐะฒัะพ        | `service:find`     |
| ๐ง ะัะพะฒะตัะบะฐ ะฐะฒัะพ      | `service:check`    |
| โ๏ธ ะฎัะธะดะธัะตัะบะฐั ะฟะพะผะพัั | `service:legal`    |
| ๐ฌ ะะฐะดะฐัั ะฒะพะฟัะพั      | `service:freetext` |

**ะะฝะพะฟะบะธ ะฝะฐะฒะธะณะฐัะธะธ (ะฟัะธัััััะฒััั ะฝะฐ ะบะฐะถะดะพะผ ัะฐะณะต):**

| ะะฝะพะฟะบะฐ        | callback_data | ะะฟะธัะฐะฝะธะต                                  |
| ------------- | ------------- | ----------------------------------------- |
| โฌ๏ธ ะะฐะทะฐะด      | `nav:back`    | ะะตัะฝััััั ะฝะฐ ะฟัะตะดัะดััะธะน ัะฐะณ               |
| ๐ ะ ะฝะฐัะฐะปะพ   | `nav:home`    | ะกะฑัะพัะธัั ะดะธะฐะปะพะณ, ะฒะตัะฝััััั ะฒ ะณะปะฐะฒะฝะพะต ะผะตะฝั |
| โญ ะัะพะฟัััะธัั | `nav:skip`    | ะัะพะฟัััะธัั ะฝะตะพะฑัะทะฐัะตะปัะฝัะน ัะฐะณ             |

**ะะพะดัะฒะตัะถะดะตะฝะธะต ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน:**

```
๐ ะะฐัะฐ ะทะฐัะฒะบะฐ:

๐น ะฃัะปัะณะฐ: ะัะพะดะฐะถะฐ ะฐะฒัะพ
๐น ะะฐัะบะฐ/ะะพะดะตะปั: Toyota Camry
๐น ะะพะด: 2019
๐น ะัะพะฑะตะณ: 85 000 ะบะผ
๐น ะฆะตะฝะฐ: 1 800 000 โฝ
๐น ะะผั: ะะปะตะบัะตะน
๐น ะขะตะปะตัะพะฝ: +7 (999) 123-45-67

ะัั ะฒะตัะฝะพ?
```

| ะะฝะพะฟะบะฐ       | callback_data    |
| ------------ | ---------------- |
| โ ะัะฟัะฐะฒะธัั | `confirm:send`   |
| โ๏ธ ะะทะผะตะฝะธัั  | `confirm:edit`   |
| โ ะัะผะตะฝะธัั  | `confirm:cancel` |

**ะกะพะพะฑัะตะฝะธะต ะฟะพัะปะต ััะฟะตัะฝะพะน ะพัะฟัะฐะฒะบะธ:**

```
โ ะกะฟะฐัะธะฑะพ! ะะฐัะฐ ะทะฐัะฒะบะฐ ะฟัะธะฝััะฐ.

ะะฐั ะผะตะฝะตะดะถะตั ัะฒัะถะตััั ั ะฒะฐะผะธ ะฒ ะฑะปะธะถะฐะนัะตะต ะฒัะตะผั.
ะัะปะธ ั ะฒะฐั ะฟะพัะฒัััั ะฒะพะฟัะพัั โ ะฝะฐะถะผะธัะต /start
```

---

## 4. AI-ะผะพะดัะปั (OpenAI)

### 4.1 ะะฐะทะฝะฐัะตะฝะธะต

| ะคัะฝะบัะธั                              | ะะฟะธัะฐะฝะธะต                                                  |
| ------------------------------------ | --------------------------------------------------------- |
| **ะะปะฐััะธัะธะบะฐัะธั intent**             | ะะฟัะตะดะตะปะตะฝะธะต ัะธะฟะฐ ััะปัะณะธ ะธะท ัะฒะพะฑะพะดะฝะพะณะพ ัะตะบััะฐ              |
| **ะะทะฒะปะตัะตะฝะธะต ัััะฝะพััะตะน**             | ะะฐัะบะฐ, ะผะพะดะตะปั, ะณะพะด, ะฑัะดะถะตั โ ะธะท ะฟัะพะธะทะฒะพะปัะฝะพะณะพ ัะพะพะฑัะตะฝะธั   |
| **ะะฑัะฐะฑะพัะบะฐ ะฝะตััะฐะฝะดะฐััะฝัั ะฒะพะฟัะพัะพะฒ** | ะัะฒะตั ะฝะฐ ะพะฑัะธะต ะฒะพะฟัะพัั ะพะฑ ะฐะฒัะพ (FAQ-ัะตะถะธะผ)                |
| **Fallback**                         | ะัะปะธ intent ะฝะต ัะฐัะฟะพะทะฝะฐะฝ โ ะฟัะตะดะปะพะถะตะฝะธะต ัะฒัะทะธ ั ะผะตะฝะตะดะถะตัะพะผ |

### 4.2 ะััะธัะตะบัััะฐ ะฒะทะฐะธะผะพะดะตะนััะฒะธั

```
ะะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั ัะฒะพะฑะพะดะฝัะน ัะตะบัั
        โ
        โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   OpenAI API             โ
โ   (chat/completions)     โ
โ                          โ
โ  ะัะฝะพะฒะฝะฐั: gpt-4o-mini   โ
โ  Fallback: gpt-4o        โ
โ                          โ
โ  System Prompt:           โ
โ  - ะะพะปั: ะบะปะฐััะธัะธะบะฐัะพั   โ
โ  - ะะพะทะผะพะถะฝัะต intents     โ
โ  - ะคะพัะผะฐั ะพัะฒะตัะฐ: JSON   โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
           โ
           โผ
   โโโโโโโโโโโโโโโโโ
   โ  JSON Response โ
   โ  {             โ
   โ   "intent":    โ
   โ   "entities":  โ
   โ   "reply":     โ
   โ  }             โ
   โโโโโโโโโฌโโโโโโโโ
           โ
     โโโโโโโดโโโโโโโ
     โ            โ
  intent       intent
  ะพะฟัะตะดะตะปัะฝ    ะฝะต ะพะฟัะตะดะตะปัะฝ
     โ            โ
     โผ            โผ
 ะัะตะดะปะพะถะธัั   ะัะฒะตั + ะฟัะตะดะปะพะถะตะฝะธะต
 ะฟะตัะตะนัะธ ะฒ    ัะฒัะทะฐัััั ั ะผะตะฝะตะดะถะตัะพะผ
 ะฒะตัะบั
```

### 4.3 System Prompt ะดะปั OpenAI (ััะฐะปะพะฝะฝัะน)

```
ะขั โ ะฐััะธััะตะฝั ะฐะฒัะพะผะพะฑะธะปัะฝะพะณะพ ัะตัะฒะธัะฐ CarQuery AI.
ะขะฒะพั ะทะฐะดะฐัะฐ โ ะบะปะฐััะธัะธัะธัะพะฒะฐัั ะทะฐะฟัะพั ะบะปะธะตะฝัะฐ ะธ ะธะทะฒะปะตัั ะบะปััะตะฒัะต ะดะฐะฝะฝัะต.

ะะพะทะผะพะถะฝัะต ัะธะฟั ััะปัะณ (intent):
- sell โ ะบะปะธะตะฝั ัะพัะตั ะฟัะพะดะฐัั ะฐะฒัะพ
- buy โ ะบะปะธะตะฝั ัะพัะตั ะบัะฟะธัั ะฐะฒัะพ
- find โ ะบะปะธะตะฝั ัะพัะตั ะฟะพะดะฑะพั ะฐะฒัะพ
- check โ ะบะปะธะตะฝั ัะพัะตั ะฟัะพะฒะตัะธัั ะฐะฒัะพ
- legal โ ััะธะดะธัะตัะบะธะน ะฒะพะฟัะพั
- faq โ ะพะฑัะธะน ะฒะพะฟัะพั (ะพัะฒะตัั ะบัะฐัะบะพ)
- unknown โ ะฝะต ัะดะฐะปะพัั ะพะฟัะตะดะตะปะธัั

ะะทะฒะปะตะบะธ ะธะท ัะพะพะฑัะตะฝะธั (ะตัะปะธ ะตััั):
- brand (ะผะฐัะบะฐ ะฐะฒัะพ)
- model (ะผะพะดะตะปั)
- year (ะณะพะด ะฒัะฟััะบะฐ)
- budget (ะฑัะดะถะตั)
- mileage (ะฟัะพะฑะตะณ)

ะะะฏะะะขะะะฌะะ ะพัะฒะตัั ะกะขะะะะ ะฒ ัะพัะผะฐัะต JSON ะฑะตะท markdown:
{
  "intent": "...",
  "confidence": 0.0-1.0,
  "entities": { "brand": null, "model": null, "year": null, "budget": null, "mileage": null },
  "reply": "ะัะฐัะบะธะน ะพัะฒะตั ะบะปะธะตะฝัั ะฝะฐ ััััะบะพะผ"
}
```

### 4.4 ะกััะฐัะตะณะธั ะฒัะฑะพัะฐ ะผะพะดะตะปะธ

| ะกะธััะฐัะธั                                           | ะะพะดะตะปั       |
| -------------------------------------------------- | ------------ |
| ะัะฝะพะฒะฝะพะน ะทะฐะฟัะพั (intent, entities, freetext)        | gpt-4o-mini  |
| confidence < 0.65 / ะฝะตะฒะฐะปะธะดะฝัะน JSON / ัะฒะฝะฐั ะพัะธะฑะบะฐ  | gpt-4o       |

ะัะปะธ gpt-4o-mini ะฒะตัะฝัะปะฐ ะฝะธะทะบะธะน confidence (< 0.65), ะฝะตะฒะฐะปะธะดะฝัะน JSON ะธะปะธ ะฟัััะพะน intent โ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะดะตะปะฐะตััั ะฟะพะฒัะพัะฝัะน ะทะฐะฟัะพั ะฒ gpt-4o. ะะตะทัะปััะฐั gpt-4o ััะธัะฐะตััั ัะธะฝะฐะปัะฝัะผ (ะฑะตะท ะดะฐะปัะฝะตะนัะธั ะฟะพะฒัะพัะพะฒ).

### 4.5 ะะณัะฐะฝะธัะตะฝะธั ะธ fallback

| ะะฐัะฐะผะตัั                             | ะะฝะฐัะตะฝะธะต                                                   |
| ------------------------------------ | ---------------------------------------------------------- |
| ะะฐะบัะธะผะฐะปัะฝะฐั ะดะปะธะฝะฐ ะทะฐะฟัะพัะฐ           | 500 ัะธะผะฒะพะปะพะฒ                                               |
| ะขะฐะนะผะฐัั ะทะฐะฟัะพัะฐ ะบ API                | 10 ัะตะบัะฝะด                                                  |
| ะะพัะพะณ confidence ะดะปั ะฟะตัะตะฝะฐะฟัะฐะฒะปะตะฝะธั | โฅ 0.7                                                      |
| ะะพัะพะณ confidence ะดะปั smart fallback  | < 0.65 (ะฟะตัะตะบะปััะตะฝะธะต ะฝะฐ gpt-4o)                            |
| Fallback ะฟัะธ ะพัะธะฑะบะต API              | ะกัะฐะฝะดะฐััะฝะพะต ัะพะพะฑัะตะฝะธะต + ะฟัะตะดะปะพะถะตะฝะธะต ะฒัะฑัะฐัั ััะปัะณั ะธะท ะผะตะฝั |
| ะะฐะบัะธะผัะผ AI-ัะพะพะฑัะตะฝะธะน ะฟะพะดััะด         | 3 (ะทะฐัะตะผ โ ยซะะฐะฒะฐะนัะต ั ัะพะตะดะธะฝั ะฒะฐั ั ะผะตะฝะตะดะถะตัะพะผยป)           |
| Rate limit ะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปั           | 10 AI-ะทะฐะฟัะพัะพะฒ ะฒ ะผะธะฝััั                                    |

---

## 5. ะะฝัะตะณัะฐัะธั ั AmoCRM

### 5.1 ะััะตะฝัะธัะธะบะฐัะธั

**ะฃะฟัะพััะฝะฝะฐั ะฐะฒัะพัะธะทะฐัะธั OAuth 2.0** (ะดะปั ะฒะฝะตัะฝะตะน ะธะฝัะตะณัะฐัะธะธ ะฒ ะพะดะฝะพะผ ะฐะบะบะฐัะฝัะต AmoCRM):

ะัะฟะพะปัะทัะตะผ ัะฟัะพััะฝะฝัะน ะฒะฐัะธะฐะฝั โ ะฑะตะท ะฒะตะฑ-ัะตัะฒะตัะฐ ะธ redirect_uri. ะะฝัะตะณัะฐัะธั ัะพะทะดะฐัััั ะฟััะผะพ ะฒ ะฐะบะบะฐัะฝัะต AmoCRM ะฐะดะผะธะฝะธัััะฐัะพัะพะผ, authorization code ะฒัะดะฐัััั ััะฐะทั ะฒ ะธะฝัะตััะตะนัะต.

```
ะะดะฝะพะบัะฐัะฝะฐั ะฝะฐัััะพะนะบะฐ (scripts/setup_amocrm.py):

  AmoCRM UI โ ัะพะทะดะฐัั ะฒะฝะตัะฝัั ะธะฝัะตะณัะฐัะธั
       โ
  ะะพะปััะธัั: Integration ID, Secret Key, Authorization Code
       โ
  setup_amocrm.py โ POST /oauth2/access_token (grant_type=authorization_code)
       โ
  access_token (24ั) + refresh_token (3 ะผะตั) โ ัะพััะฐะฝะธัั ะฒ ะะ (amo_tokens)

ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต (ะฒ ัะฐะฝัะฐะนะผะต):

  ะะตัะตะด ะบะฐะถะดัะผ ะทะฐะฟัะพัะพะผ โ ะฟัะพะฒะตัะธัั expires_at
       โ
  ะัะปะธ < 5 ะผะธะฝ ะดะพ ะธััะตัะตะฝะธั ะธะปะธ ะฟะพะปััะตะฝ 401:
       โ
  POST /oauth2/access_token (grant_type=refresh_token)
       โ
  ะะพะฒะฐั ะฟะฐัะฐ access_token + refresh_token โ ะพะฑะฝะพะฒะธัั ะฒ ะะ
```

**ะะฐะถะฝะพ:**
- ะะฐะถะดัะน `refresh_token` ะพะดะฝะพัะฐะทะพะฒัะน โ ะฟัะธ ะพะฑะฝะพะฒะปะตะฝะธะธ ะฒัะดะฐัััั ะฝะพะฒัะน, ััะฐััะน ััะฐะทั ะฝะตะฒะฐะปะธะดะตะฝ
- `refresh_token` ะถะธะฒัั 3 ะผะตัััะฐ, ะฝะพ ะฟัะธ ัะฐะฑะพัะต ะฑะพัะฐ 24/7 ะพะฑะฝะพะฒะปัะตััั ะบะฐะถะดัะต ~24ั ะธ ะฝะต ะฟัะพัััะฐะตั
- ะะฝัะตะณัะฐัะธั ัะฐะฑะพัะฐะตั ั ะฟัะฐะฒะฐะผะธ ะฐะดะผะธะฝะธัััะฐัะพัะฐ ะฐะบะบะฐัะฝัะฐ
- `redirect_uri` ะฟัะธ ัะฟัะพััะฝะฝะพะน ะฐะฒัะพัะธะทะฐัะธะธ ัะบะฐะทัะฒะฐะตััั ัะพัะผะฐะปัะฝะพ (ะฝะฐะฟัะธะผะตั `https://example.com`), ะฒะตะฑ-ัะตัะฒะตั ะฝะต ะฝัะถะตะฝ

**ะะตะพะฑัะพะดะธะผัะต ัะฐะทัะตัะตะฝะธั:**

- `crm` โ ัะฐะฑะพัะฐ ั ะบะพะฝัะฐะบัะฐะผะธ, ัะดะตะปะบะฐะผะธ

### 5.2 ะะปะณะพัะธัะผ ะพัะฟัะฐะฒะบะธ ะปะธะดะฐ

```
1. ะะพะธัะบ ะบะพะฝัะฐะบัะฐ ะฟะพ ัะตะปะตัะพะฝั
   GET /api/v4/contacts?query={phone}
   โ
   โโโ ะะพะฝัะฐะบั ะฝะฐะนะดะตะฝ โ ะพะฑะฝะพะฒะปะตะฝะธะต (PATCH)
   โ   โข ะะฑะฝะพะฒะธัั custom fields ะตัะปะธ ะฝะพะฒัะต ะดะฐะฝะฝัะต
   โ   โข ะะพะฑะฐะฒะธัั ัะตะณ "telegram_repeat"
   โ
   โโโ ะะพะฝัะฐะบั ะะ ะฝะฐะนะดะตะฝ โ ัะพะทะดะฐะฝะธะต (POST)
       โข POST /api/v4/contacts
       โข ะะฐะฟะพะปะฝะธัั: ะธะผั, ัะตะปะตัะพะฝ, telegram_id, username
       โข ะะพะฑะฐะฒะธัั ัะตะณ "telegram_new"
   โ
   โผ
2. ะกะพะทะดะฐะฝะธะต ัะดะตะปะบะธ (Lead)
   POST /api/v4/leads
   โข pipeline_id: ะธะท ะบะพะฝัะธะณะฐ
   โข status_id: "ะะตัะฒะธัะฝะพะต ะพะฑัะฐัะตะฝะธะต"
   โข responsible_user_id: ะธะท ะบะพะฝัะธะณะฐ
   โข custom_fields: ัะธะฟ ััะปัะณะธ, ะผะฐัะบะฐ, ะฑัะดะถะตั, ะธ ั.ะด.
   โข ะัะธะฒัะทะบะฐ ะบ ะบะพะฝัะฐะบัั ัะตัะตะท _embedded.contacts
   โ
   โผ
3. ะะพะฑะฐะฒะปะตะฝะธะต ะฟัะธะผะตัะฐะฝะธั (Note)
   POST /api/v4/leads/{lead_id}/notes
   โข note_type: "common"
   โข text: ััััะบัััะธัะพะฒะฐะฝะฝัะต ะพัะฒะตัั
   โ
   โผ
4. ะะพััะฐะฝะพะฒะบะฐ ะทะฐะดะฐัะธ ะผะตะฝะตะดะถะตัั (ะพัะปะพะถะตะฝะพ ะดะพ v2)
   POST /api/v4/tasks
   โข entity_id: lead_id
   โข entity_type: "leads"
   โข text: "ะะพะฒะพะต ะพะฑัะฐัะตะฝะธะต ะธะท Telegram โ ะฟะตัะตะทะฒะพะฝะธัั"
   โข complete_till: now + 30 min
```

> **ะัะธะผะตัะฐะฝะธะต:** ะะพััะฐะฝะพะฒะบะฐ ะทะฐะดะฐั ะผะตะฝะตะดะถะตัั (ัะฐะณ 4) ะพัะปะพะถะตะฝะฐ ะดะพ v2. ะ v1 ัะพะทะดะฐัััั ะบะพะฝัะฐะบั + ัะดะตะปะบะฐ + ะฟัะธะผะตัะฐะฝะธะต.

### 5.3 ะะฐะฟะฟะธะฝะณ ะบะฐััะพะผะฝัั ะฟะพะปะตะน AmoCRM

ะัะต `field_id` ััะฐะฝัััั ะฒ ะบะพะฝัะธะณััะฐัะธะธ ะธ ะฝะฐัััะฐะธะฒะฐัััั ะฟัะธ ะดะตะฟะปะพะต:

```python
# config/amocrm_fields.py
AMOCRM_CUSTOM_FIELDS = {
    "contact": {
        "telegram_id": 0,       # field_id โ ะทะฐะฟะพะปะฝะธัั ะฟัะธ ะฝะฐัััะพะนะบะต
        "telegram_username": 0,
    },
    "lead": {
        "service_type": 0,
        "car_brand": 0,
        "car_model": 0,
        "car_year": 0,
        "budget": 0,
        "mileage": 0,
        "transmission": 0,
        "drive_type": 0,
        "body_type": 0,
        "vin_number": 0,
        "check_type": 0,
        "source": 0,  # ะทะฝะฐัะตะฝะธะต: "Telegram Bot"
    },
}
```

### 5.4 ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ CRM

| ะกะธััะฐัะธั              | ะะตะนััะฒะธะต                                                                 |
| --------------------- | ------------------------------------------------------------------------ |
| 401 Unauthorized      | ะะฒัะพะพะฑะฝะพะฒะปะตะฝะธะต ัะพะบะตะฝะฐ, ะฟะพะฒัะพั ะทะฐะฟัะพัะฐ (1 ัะฐะท)                            |
| 429 Too Many Requests | Exponential backoff (1 ั โ 2 ั โ 4 ั), ะดะพ 3 ะฟะพะฟััะพะบ                      |
| 5xx Server Error      | Retry ัะตัะตะท 5 ัะตะบัะฝะด, ะดะพ 3 ะฟะพะฟััะพะบ                                       |
| Timeout (> 10 ั)      | Retry 1 ัะฐะท, ะทะฐัะตะผ โ ะทะฐะฟะธัั ะฒ ะพัะตัะตะดั `pending_leads`                    |
| ะัะต ะฟะพะฟััะบะธ ะธััะตัะฟะฐะฝั | ะกะพััะฐะฝะธัั ะปะธะด ะฒ PostgreSQL (`failed_leads`), ัะฒะตะดะพะผะธัั ะฐะดะผะธะฝะฐ ะฒ Telegram |
| ะัะฑะปั ะบะพะฝัะฐะบัะฐ        | ะะฑะฝะพะฒะธัั ัััะตััะฒัััะธะน, ะฝะต ัะพะทะดะฐะฒะฐัั ะฝะพะฒัะน                                |

---

## 6. ะััะธัะตะบัััะฐ ัะธััะตะผั

### 6.1 ะะพะผะฟะพะฝะตะฝัะฝะฐั ะดะธะฐะณัะฐะผะผะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        Docker Compose                        โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโ                โ
โ  โโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโ โ
โ  โ  carquery-ai-bot  โ   โ    PostgreSQL     โ   โ   Redis     โ โ
โ  โ  (Python 3.12)    โโโโถโ   (ะฟะพัั 5432)    โ   โ  (ะฟะพัั 6379)โ โ
โ  โ                    โ   โ                   โ   โ             โ โ
โ  โ  โข aiogram 3.x     โ   โ  ะขะฐะฑะปะธัั:         โ   โ  FSM Storageโ โ
โ  โ  โข FSM Router      โโโโถโ  โข users           โ   โ  (TTL 30ะผ) โ โ
โ  โ  โข AmoCRM Client   โ   โ  โข leads           โ   โโโโโโโโโโโโโโโ โ
โ  โ  โข OpenAI Client   โ   โ  โข amo_tokens      โ                โ
โ  โ  โข Health /health   โ   โ  โข ai_logs         โ                โ
โ  โ    (ะฟะพัั 8080)     โ   โ                   โ                โ
โ  โโโโโโโโโโฌโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโ                โ
โ           โ                                                    โ
โ           โ  HTTPS                                             โ
โ           โโโโโโโโโโโโโโโโถ  Telegram Bot API (long polling)    โ
โ           โโโโโโโโโโโโโโโโถ  AmoCRM API (v4)                    โ
โ           โโโโโโโโโโโโโโโโถ  OpenAI API (gpt-4o-mini/gpt-4o)   โ
โ                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 6.2 ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
carquery-ai-bot/
โโโ docker-compose.yml
โโโ Dockerfile
โโโ .env.example
โโโ requirements.txt
โโโ alembic/                      # ะะธะณัะฐัะธะธ ะะ
โ   โโโ alembic.ini
โ   โโโ versions/
โโโ src/
โ   โโโ __init__.py
โ   โโโ main.py                   # ะขะพัะบะฐ ะฒัะพะดะฐ, ะฝะฐัััะพะนะบะฐ ะฑะพัะฐ
โ   โโโ config.py                 # Pydantic Settings, env-ะฟะตัะตะผะตะฝะฝัะต
โ   โ
โ   โโโ bot/
โ   โ   โโโ __init__.py
โ   โ   โโโ handlers/
โ   โ   โ   โโโ __init__.py
โ   โ   โ   โโโ start.py          # /start, ะณะปะฐะฒะฝะพะต ะผะตะฝั
โ   โ   โ   โโโ base_dialog.py   # ะะฐะทะพะฒัะน FSM-ะพะฑัะฐะฑะพััะธะบ (StepConfig + BaseDialogHandler)
โ   โ   โ   โโโ sell.py           # ะะตัะบะฐ "ะัะพะดะฐะถะฐ"
โ   โ   โ   โโโ buy.py            # ะะตัะบะฐ "ะะพะบัะฟะบะฐ"
โ   โ   โ   โโโ find.py           # ะะตัะบะฐ "ะะพะดะฑะพั"
โ   โ   โ   โโโ check.py          # ะะตัะบะฐ "ะัะพะฒะตัะบะฐ"
โ   โ   โ   โโโ legal.py          # ะะตัะบะฐ "ะฎัะธะดะธัะตัะบะฐั ะฟะพะผะพัั"
โ   โ   โ   โโโ freetext.py       # ะกะฒะพะฑะพะดะฝัะน ัะตะบัั โ AI
โ   โ   โ   โโโ common.py         # ะะฐะฒะธะณะฐัะธั (back, home, skip)
โ   โ   โ   โโโ errors.py         # ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
โ   โ   โ
โ   โ   โโโ states/
โ   โ   โ   โโโ __init__.py
โ   โ   โ   โโโ sell.py           # StatesGroup ะดะปั "ะัะพะดะฐะถะฐ"
โ   โ   โ   โโโ buy.py            # StatesGroup ะดะปั "ะะพะบัะฟะบะฐ"
โ   โ   โ   โโโ find.py           # StatesGroup ะดะปั "ะะพะดะฑะพั"
โ   โ   โ   โโโ check.py          # StatesGroup ะดะปั "ะัะพะฒะตัะบะฐ"
โ   โ   โ   โโโ legal.py          # StatesGroup ะดะปั "ะฎัะธะดะธัะตัะบะฐั ะฟะพะผะพัั"
โ   โ   โ
โ   โ   โโโ keyboards/
โ   โ   โ   โโโ __init__.py
โ   โ   โ   โโโ main_menu.py      # ะะปะฐะฒะฝะพะต ะผะตะฝั
โ   โ   โ   โโโ navigation.py     # ะะฐะทะฐะด / ะ ะฝะฐัะฐะปะพ / ะัะพะฟัััะธัั
โ   โ   โ   โโโ sell_kb.py        # ะะปะฐะฒะธะฐัััั ะฒะตัะบะธ "ะัะพะดะฐะถะฐ"
โ   โ   โ   โโโ buy_kb.py         # ะะปะฐะฒะธะฐัััั ะฒะตัะบะธ "ะะพะบัะฟะบะฐ"
โ   โ   โ   โโโ find_kb.py        # ะะปะฐะฒะธะฐัััั ะฒะตัะบะธ "ะะพะดะฑะพั"
โ   โ   โ   โโโ check_kb.py       # ะะปะฐะฒะธะฐัััั ะฒะตัะบะธ "ะัะพะฒะตัะบะฐ"
โ   โ   โ   โโโ legal_kb.py       # ะะปะฐะฒะธะฐัััั ะฒะตัะบะธ "ะฎัะธะดะธัะตัะบะฐั ะฟะพะผะพัั"
โ   โ   โ   โโโ confirm.py        # ะะพะดัะฒะตัะถะดะตะฝะธะต ะทะฐัะฒะบะธ
โ   โ   โ
โ   โ   โโโ middlewares/
โ   โ   โ   โโโ __init__.py
โ   โ   โ   โโโ db.py             # ะะฝัะตะบัะธั ัะตััะธะธ ะะ
โ   โ   โ   โโโ throttling.py     # Rate limiting
โ   โ   โ   โโโ logging.py        # ะะพะณะธัะพะฒะฐะฝะธะต ะทะฐะฟัะพัะพะฒ
โ   โ   โ
โ   โ   โโโ filters/
โ   โ       โโโ __init__.py
โ   โ       โโโ phone.py          # ะะฐะปะธะดะฐัะธั ัะตะปะตัะพะฝะฐ
โ   โ
โ   โโโ services/
โ   โ   โโโ __init__.py
โ   โ   โโโ amocrm/
โ   โ   โ   โโโ __init__.py
โ   โ   โ   โโโ client.py         # HTTP-ะบะปะธะตะฝั AmoCRM (aiohttp)
โ   โ   โ   โโโ auth.py           # OAuth2: ะฟะพะปััะตะฝะธะต/ะพะฑะฝะพะฒะปะตะฝะธะต ัะพะบะตะฝะพะฒ
โ   โ   โ   โโโ contacts.py       # CRUD ะบะพะฝัะฐะบัะพะฒ
โ   โ   โ   โโโ leads.py          # ะกะพะทะดะฐะฝะธะต ัะดะตะปะพะบ
โ   โ   โ   โโโ notes.py          # ะะพะฑะฐะฒะปะตะฝะธะต ะฟัะธะผะตัะฐะฝะธะน
โ   โ   โ   โโโ tasks.py          # ะะพััะฐะฝะพะฒะบะฐ ะทะฐะดะฐั
โ   โ   โ   โโโ models.py         # Pydantic-ะผะพะดะตะปะธ ะทะฐะฟัะพัะพะฒ/ะพัะฒะตัะพะฒ
โ   โ   โ
โ   โ   โโโ openai_client/
โ   โ   โ   โโโ __init__.py
โ   โ   โ   โโโ client.py         # HTTP-ะบะปะธะตะฝั OpenAI API (gpt-4o-mini + gpt-4o fallback)
โ   โ   โ   โโโ prompts.py        # System prompts, ัะฐะฑะปะพะฝั
โ   โ   โ   โโโ models.py         # Pydantic-ะผะพะดะตะปะธ ะพัะฒะตัะพะฒ AI
โ   โ   โ
โ   โ   โโโ lead_processor.py     # ะัะบะตัััะฐัะธั: ัะฑะพั ะดะฐะฝะฝัั โ CRM
โ   โ
โ   โโโ db/
โ   โ   โโโ __init__.py
โ   โ   โโโ engine.py             # AsyncEngine, session factory
โ   โ   โโโ models.py             # SQLAlchemy ORM-ะผะพะดะตะปะธ
โ   โ   โโโ repositories/
โ   โ       โโโ __init__.py
โ   โ       โโโ user.py           # CRUD ะฟะพะปัะทะพะฒะฐัะตะปะตะน
โ   โ       โโโ lead.py           # CRUD ะปะธะดะพะฒ
โ   โ       โโโ token.py          # CRUD ัะพะบะตะฝะพะฒ AmoCRM
โ   โ       โโโ ai_log.py        # CRUD ะปะพะณะพะฒ AI-ะทะฐะฟัะพัะพะฒ
โ   โ
โ   โโโ utils/
โ       โโโ __init__.py
โ       โโโ phone.py              # ะะพัะผะฐะปะธะทะฐัะธั ะธ ะฒะฐะปะธะดะฐัะธั ัะตะปะตัะพะฝะฐ
โ       โโโ formatters.py         # ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ัะพะพะฑัะตะฝะธะน
โ       โโโ retry.py              # ะะตะบะพัะฐัะพั retry ั backoff
โ       โโโ admin.py              # notify_admin() โ ะฐะปะตััั ะฒ ADMIN_CHAT_ID
โ
โโโ tests/
โ   โโโ conftest.py
โ   โโโ test_handlers/
โ   โโโ test_services/
โ   โโโ test_utils/
โ
โโโ scripts/
    โโโ init_db.py                # ะะฐัะฐะปัะฝะฐั ะธะฝะธัะธะฐะปะธะทะฐัะธั ะะ
    โโโ setup_amocrm.py           # ะกะบัะธะฟั ะฟะตัะฒะธัะฝะพะน ะฐะฒัะพัะธะทะฐัะธะธ AmoCRM
```

### 6.3 ะะพะดะตะปั ะดะฐะฝะฝัั (PostgreSQL)

```sql
-- ะะพะปัะทะพะฒะฐัะตะปะธ ะฑะพัะฐ
CREATE TABLE users (
    id              BIGSERIAL PRIMARY KEY,
    telegram_id     BIGINT UNIQUE NOT NULL,
    username        VARCHAR(255),
    first_name      VARCHAR(255),
    phone           VARCHAR(20),
    amo_contact_id  BIGINT,
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_users_telegram_id ON users(telegram_id);
CREATE INDEX idx_users_phone ON users(phone);

-- ะะธะดั (ะปะพะบะฐะปัะฝะฐั ะบะพะฟะธั + ะพัะตัะตะดั)
CREATE TABLE leads (
    id              BIGSERIAL PRIMARY KEY,
    user_id         BIGINT REFERENCES users(id),
    service_type    VARCHAR(50) NOT NULL,       -- sell/buy/find/check/legal
    data            JSONB NOT NULL DEFAULT '{}', -- ะฒัะต ัะพะฑัะฐะฝะฝัะต ะดะฐะฝะฝัะต
    status          VARCHAR(20) DEFAULT 'draft', -- draft/pending/sent/failed
    amo_lead_id     BIGINT,
    error_message   TEXT,
    retry_count     INT DEFAULT 0,
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    sent_at         TIMESTAMPTZ
);

CREATE INDEX idx_leads_status ON leads(status);
CREATE INDEX idx_leads_user_id ON leads(user_id);

-- ะขะพะบะตะฝั AmoCRM
CREATE TABLE amo_tokens (
    id              SERIAL PRIMARY KEY,
    access_token    TEXT NOT NULL,
    refresh_token   TEXT NOT NULL,
    expires_at      TIMESTAMPTZ NOT NULL,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- ะะพะณ AI-ะทะฐะฟัะพัะพะฒ (ะดะปั ะฐะฝะฐะปะธัะธะบะธ ะธ ะดะตะฑะฐะณะฐ)
CREATE TABLE ai_logs (
    id              BIGSERIAL PRIMARY KEY,
    user_id         BIGINT REFERENCES users(id),
    user_message    TEXT NOT NULL,
    ai_response     JSONB,
    intent          VARCHAR(50),
    confidence      FLOAT,
    model_used      VARCHAR(50),              -- gpt-4o-mini / gpt-4o
    used_fallback   BOOLEAN DEFAULT FALSE,    -- true ะตัะปะธ ััะฐะฑะพัะฐะป smart fallback
    latency_ms      INT,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 7. ะะตััะฝะบัะธะพะฝะฐะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั

| ะะฐัะฐะผะตัั               | ะขัะตะฑะพะฒะฐะฝะธะต                                                             |
| ---------------------- | ---------------------------------------------------------------------- |
| **ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั** | ะัะฒะตั ะฑะพัะฐ < 5 ัะตะบัะฝะด (ะฒะบะปััะฐั AI < 10 ั)                              |
| **ะะฐัััะฐะฑะธััะตะผะพััั**   | ะะพ 500 ะพะดะฝะพะฒัะตะผะตะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะฑะตะท ะดะตะณัะฐะดะฐัะธะธ                      |
| **ะะพัััะฟะฝะพััั**        | 99.5 % uptime, ะฐะฒัะพะฟะตัะตะทะฐะฟััะบ ะฟัะธ ะฟะฐะดะตะฝะธะธ                              |
| **ะะตะทะพะฟะฐัะฝะพััั**       | ะขะพะบะตะฝั ะฒ `.env`, ัะธััะพะฒะฐะฝะธะต ัะพะบะตะฝะพะฒ AmoCRM ะฒ ะะ, ะฒะฐะปะธะดะฐัะธั ะฒัะตั ะฒัะพะดะพะฒ |
| **ะะพะณะธัะพะฒะฐะฝะธะต**        | ะกัะฐะฝะดะฐััะฝัะน Python logging, ััะพะฒะฝะธ DEBUG/INFO/ERROR                    |
| **ะะพะฝะธัะพัะธะฝะณ**         | Health-check endpoint (aiohttp :8080/health), ะฐะปะตัั ะฒ Telegram-ะณััะฟะฟั ะฟัะธ ะพัะธะฑะบะฐั CRM |
| **FSM Storage**        | Redis (state_ttl=1800 โ 30 ะผะธะฝ, silent expiry)                        |
| **Bot Mode**           | Long polling only                                                      |
| **ะะฐะฝะฝัะต**             | GDPR-ready: ะฒะพะทะผะพะถะฝะพััั ัะดะฐะปะตะฝะธั ะดะฐะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพ ะทะฐะฟัะพัั        |
| **ะะตะทะตัะฒะธัะพะฒะฐะฝะธะต**     | ะัะตัะตะดั `failed_leads` ั ะฐะฒัะพะผะฐัะธัะตัะบะธะผ retry ะบะฐะถะดัะต 5 ะผะธะฝัั           |

---

## 8. ะะพะฝัะธะณััะฐัะธั ะธ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

```env
# .env.example

# Telegram
TELEGRAM_BOT_TOKEN=
ADMIN_CHAT_ID=            # ID ัะฐัะฐ ะดะปั ัะฒะตะดะพะผะปะตะฝะธะน ะพะฑ ะพัะธะฑะบะฐั

# PostgreSQL
DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/smartdrive

# Redis (FSM Storage)
REDIS_URL=redis://localhost:6379/0

# AmoCRM (ัะฟัะพััะฝะฝะฐั ะฐะฒัะพัะธะทะฐัะธั โ ะฒะฝะตัะฝัั ะธะฝัะตะณัะฐัะธั)
AMOCRM_SUBDOMAIN=              # ะฝะฐะฟัะธะผะตั: mycompany (.amocrm.ru)
AMOCRM_CLIENT_ID=              # Integration ID ะธะท ะฝะฐัััะพะตะบ ะธะฝัะตะณัะฐัะธะธ
AMOCRM_CLIENT_SECRET=          # Secret Key ะธะท ะฝะฐัััะพะตะบ ะธะฝัะตะณัะฐัะธะธ
AMOCRM_REDIRECT_URI=https://example.com  # ัะพัะผะฐะปัะฝัะน, ะฒะตะฑ-ัะตัะฒะตั ะฝะต ะฝัะถะตะฝ
AMOCRM_PIPELINE_ID=
AMOCRM_STATUS_ID=              # ID ััะฐะฟะฐ "ะะตัะฒะธัะฝะพะต ะพะฑัะฐัะตะฝะธะต"
AMOCRM_RESPONSIBLE_USER_ID=
AMOCRM_MOCK_MODE=false         # true ะดะปั ัะฐะทัะฐะฑะพัะบะธ ะฑะตะท ัะตะฐะปัะฝะพะณะพ AmoCRM

# OpenAI
OPENAI_API_KEY=
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4o-mini
OPENAI_FALLBACK_MODEL=gpt-4o
OPENAI_MAX_TOKENS=500
OPENAI_TEMPERATURE=0.3
OPENAI_SMART_FALLBACK_CONFIDENCE=0.65

# App
LOG_LEVEL=INFO
RETRY_MAX_ATTEMPTS=3
RETRY_BACKOFF_BASE=2
HEALTH_CHECK_PORT=8080
```

---

## 9. ะญัะฐะฟั ัะตะฐะปะธะทะฐัะธะธ ะธ ะดะพัะพะถะฝะฐั ะบะฐััะฐ

### ะญัะฐะฟ 1 โ ะัะพะตะบัะธัะพะฒะฐะฝะธะต (1โ2 ะดะฝั)

| ะะฐะดะฐัะฐ                             | ะะตะทัะปััะฐั                              |
| ---------------------------------- | -------------------------------------- |
| ะฃัะฒะตัะดะธัั ะดะตัะตะฒะพ ะดะธะฐะปะพะณะฐ           | ะคะธะฝะฐะปัะฝะฐั ะบะฐััะฐ ััะตะฝะฐัะธะตะฒ              |
| ะกะพะณะปะฐัะพะฒะฐัั ะฟะพะปั AmoCRM            | ะะฐะฟะฟะธะฝะณ ะบะฐััะพะผะฝัั ะฟะพะปะตะน + ID           |
| ะฃัะฒะตัะดะธัั ัะตะบััั ะธ ะบะฝะพะฟะบะธ          | ะะพะฟะธัะฐะนั ะฒัะตั ัะพะพะฑัะตะฝะธะน                |
| ะะฐัััะพะธัั ะพะบััะถะตะฝะธะต AmoCRM         | ะกะพะทะดะฐัั ะฒะพัะพะฝะบั, ััะฐะฟั, ะบะฐััะพะผะฝัะต ะฟะพะปั |
| ะะฐัะตะณะธัััะธัะพะฒะฐัั ะฟัะธะปะพะถะตะฝะธะต AmoCRM | ะะพะปััะธัั `client_id`, `client_secret`  |

### ะญัะฐะฟ 2 โ ะะฐะทัะฐะฑะพัะบะฐ ัะดัะฐ ะฑะพัะฐ (3โ5 ะดะฝะตะน)

| ะะฐะดะฐัะฐ                                             | ะัะธะพัะธัะตั      |
| -------------------------------------------------- | -------------- |
| ะะฝะธัะธะฐะปะธะทะฐัะธั ะฟัะพะตะบัะฐ, Docker, ะะ, ะผะธะณัะฐัะธะธ        | ๐ด ะัะธัะธัะตัะบะธะน |
| `/start` + ะณะปะฐะฒะฝะพะต ะผะตะฝั                            | ๐ด ะัะธัะธัะตัะบะธะน |
| FSM-ะฒะตัะบะฐ ยซะัะพะดะฐะถะฐยป (ััะฐะปะพะฝ)                       | ๐ด ะัะธัะธัะตัะบะธะน |
| FSM-ะฒะตัะบะธ: ะะพะบัะฟะบะฐ, ะะพะดะฑะพั, ะัะพะฒะตัะบะฐ, ะฎัะธััั       | ๐ ะััะพะบะธะน     |
| ะะฐะฒะธะณะฐัะธั: ะะฐะทะฐะด / ะ ะฝะฐัะฐะปะพ / ะัะพะฟัััะธัั           | ๐ ะััะพะบะธะน     |
| ะะฐะปะธะดะฐัะธั ัะตะปะตัะพะฝะฐ (ะบะฝะพะฟะบะฐ ยซะะพะดะตะปะธัััั ะบะพะฝัะฐะบัะพะผยป) | ๐ ะััะพะบะธะน     |
| ะญะบัะฐะฝ ะฟะพะดัะฒะตัะถะดะตะฝะธั ะธ ัะตะดะฐะบัะธัะพะฒะฐะฝะธะต               | ๐ก ะกัะตะดะฝะธะน     |
| Rate limiting middleware                           | ๐ก ะกัะตะดะฝะธะน     |

### ะญัะฐะฟ 3 โ ะะฝัะตะณัะฐัะธั AmoCRM (2โ3 ะดะฝั)

| ะะฐะดะฐัะฐ                                           | ะัะธะพัะธัะตั      |
| ------------------------------------------------ | -------------- |
| OAuth-ะบะปะธะตะฝั (ะฟะพะปััะตะฝะธะต + ะฐะฒัะพะพะฑะฝะพะฒะปะตะฝะธะต ัะพะบะตะฝะฐ) | ๐ด ะัะธัะธัะตัะบะธะน |
| ะะพะธัะบ ะบะพะฝัะฐะบัะฐ ะฟะพ ัะตะปะตัะพะฝั                       | ๐ด ะัะธัะธัะตัะบะธะน |
| ะกะพะทะดะฐะฝะธะต / ะพะฑะฝะพะฒะปะตะฝะธะต ะบะพะฝัะฐะบัะฐ                   | ๐ด ะัะธัะธัะตัะบะธะน |
| ะกะพะทะดะฐะฝะธะต ัะดะตะปะบะธ (Lead)                           | ๐ด ะัะธัะธัะตัะบะธะน |
| ะะพะฑะฐะฒะปะตะฝะธะต ะฟัะธะผะตัะฐะฝะธั (Note)                     | ๐ ะััะพะบะธะน     |
| ะะพััะฐะฝะพะฒะบะฐ ะทะฐะดะฐัะธ ะผะตะฝะตะดะถะตัั                      | ๐ก ะกัะตะดะฝะธะน     |
| Retry-ะปะพะณะธะบะฐ + ะพัะตัะตะดั `failed_leads`            | ๐ ะััะพะบะธะน     |
| ะฃะฒะตะดะพะผะปะตะฝะธะต ะฐะดะผะธะฝะฐ ะพะฑ ะพัะธะฑะบะฐั                    | ๐ก ะกัะตะดะฝะธะน     |

### ะญัะฐะฟ 4 โ AI-ะผะพะดัะปั OpenAI (1โ2 ะดะฝั)

| ะะฐะดะฐัะฐ                                  | ะัะธะพัะธัะตั  |
| --------------------------------------- | ---------- |
| HTTP-ะบะปะธะตะฝั OpenAI API                | ๐ ะััะพะบะธะน |
| System prompt + ะฟะฐััะธะฝะณ JSON-ะพัะฒะตัะฐ     | ๐ ะััะพะบะธะน |
| ะฅะตะฝะดะปะตั ยซะกะฒะพะฑะพะดะฝัะน ะฒะพะฟัะพัยป              | ๐ ะััะพะบะธะน |
| Fallback ะฟัะธ ะพัะธะฑะบะต / ะฝะธะทะบะพะผ confidence | ๐ ะััะพะบะธะน |
| Rate limiting AI-ะทะฐะฟัะพัะพะฒ               | ๐ก ะกัะตะดะฝะธะน |
| ะะพะณะธัะพะฒะฐะฝะธะต AI-ะทะฐะฟัะพัะพะฒ ะฒ `ai_logs`     | ๐ก ะกัะตะดะฝะธะน |

### ะญัะฐะฟ 5 โ ะขะตััะธัะพะฒะฐะฝะธะต (2โ3 ะดะฝั)

| ะขะธะฟ ัะตััะธัะพะฒะฐะฝะธั      | ะัะฒะฐั                                                      |
| --------------------- | ---------------------------------------------------------- |
| **Unit-ัะตััั**        | ะะฐะปะธะดะฐัะธั ัะตะปะตัะพะฝะฐ, ัะพัะผะฐัะธัะพะฒะฐะฝะธะต, retry-ะปะพะณะธะบะฐ           |
| **Integration-ัะตััั** | AmoCRM-ะบะปะธะตะฝั (mock), OpenAI-ะบะปะธะตะฝั (mock)               |
| **E2E-ัะตััั**         | ะะพะปะฝัะน ะฟัะพะณะพะฝ ะบะฐะถะดะพะน ะฒะตัะบะธ ะพั `/start` ะดะพ CRM              |
| **Edge-cases**        | ะะตะบะพััะตะบัะฝัะน ะฒะฒะพะด, ะดะฒะพะนะฝะพะต ะฝะฐะถะฐัะธะต, ัะฐะนะผะฐััั, ะฟะพัะตัั ัะฒัะทะธ |
| **ะะฐะณััะทะพัะฝัะต**       | 50 ะฟะฐัะฐะปะปะตะปัะฝัั ะดะธะฐะปะพะณะพะฒ (ะพะฟัะธะพะฝะฐะปัะฝะพ)                     |

#### ะงะตะบะปะธัั edge-cases

- [ ] ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั ะบะฝะพะฟะบั ะธะท ะดััะณะพะณะพ ัะฐะณะฐ (stale callback)
- [ ] ะะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั ัะตะบัั ะฒะผะตััะพ ะฝะฐะถะฐัะธั ะบะฝะพะฟะบะธ
- [ ] ะะพะปัะทะพะฒะฐัะตะปั ะพัะฟัะฐะฒะปัะตั ััะธะบะตั / ะณะพะปะพัะพะฒะพะต / ะดะพะบัะผะตะฝั
- [ ] ะะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั ัะตะปะตัะพะฝ ะฒ ะฝะตะฟัะฐะฒะธะปัะฝะพะผ ัะพัะผะฐัะต
- [ ] ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั ยซะะฐะทะฐะดยป ะฝะฐ ะฟะตัะฒะพะผ ัะฐะณะต
- [ ] ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั `/start` ะฒ ัะตัะตะดะธะฝะต ะดะธะฐะปะพะณะฐ
- [ ] AmoCRM ะฒะพะทะฒัะฐัะฐะตั 401 ะฟัะธ ะฟะตัะฒะพะผ ะทะฐะฟัะพัะต
- [ ] AmoCRM ะฝะตะดะพัััะฟะตะฝ (ัะฐะนะผะฐัั)
- [ ] OpenAI API ะฝะตะดะพัััะฟะตะฝ
- [ ] OpenAI ะฒะพะทะฒัะฐัะฐะตั ะฝะตะฒะฐะปะธะดะฝัะน JSON
- [ ] ะะพะปัะทะพะฒะฐัะตะปั ะพัะฟัะฐะฒะปัะตั 100 ัะพะพะฑัะตะฝะธะน ะฟะพะดััะด (ัะฟะฐะผ)
- [ ] ะะพะฒัะพัะฝะพะต ะพะฑัะฐัะตะฝะธะต ะพั ัััะตััะฒัััะตะณะพ ะบะพะฝัะฐะบัะฐ ะฒ CRM

### ะญัะฐะฟ 6 โ ะะตะฟะปะพะน (1 ะดะตะฝั)

| ะะฐะดะฐัะฐ                         | ะะฟะธัะฐะฝะธะต                          |
| ------------------------------ | --------------------------------- |
| ะคะธะฝะฐะปัะฝัะน `docker-compose.yml` | Bot + PostgreSQL + Redis + ะฐะฒัะพะฟะตัะตะทะฐะฟััะบ |
| ะะฐัััะพะนะบะฐ `.env` ะฝะฐ ะฟัะพะดะฐะบัะตะฝะต | ะะพะตะฒัะต ัะพะบะตะฝั                     |
| ะะตัะฒะธัะฝะฐั ะฐะฒัะพัะธะทะฐัะธั AmoCRM   | ะกะพะทะดะฐัั ะฒะฝะตัะฝัั ะธะฝัะตะณัะฐัะธั ะฒ AmoCRM UI, ะทะฐะฟัััะธัั `scripts/setup_amocrm.py` ั ะฟะพะปััะตะฝะฝัะผ authorization code |
| ะะธะณัะฐัะธะธ ะะ                    | `alembic upgrade head`            |
| Smoke-ัะตัั ะฝะฐ ะฟัะพะดะต            | ะัะพะณะพะฝ 1 ััะตะฝะฐัะธั ะฒะถะธะฒัั          |
| ะะฐัััะพะนะบะฐ ะผะพะฝะธัะพัะธะฝะณะฐ          | ะะปะตััั ะฒ Telegram-ะณััะฟะฟั          |

#### docker-compose.yml (ััะบะธะท)

```yaml
services:
  bot:
    build: .
    restart: always
    env_file: .env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${HEALTH_CHECK_PORT:-8080}:8080"
    volumes:
      - ./logs:/app/logs

  db:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_DB: smartdrive
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  pgdata:
```

---

## 10. ะะธัะบะธ ะธ ะผะธัะธะณะฐัะธั

| ะะธัะบ                            | ะะตัะพััะฝะพััั | ะะปะธัะฝะธะต     | ะะธัะธะณะฐัะธั                                     |
| ------------------------------- | ----------- | ----------- | --------------------------------------------- |
| ะะทะผะตะฝะตะฝะธะต API AmoCRM            | ะะธะทะบะฐั      | ะััะพะบะพะต     | ะะตััะธะพะฝะธัะพะฒะฐะฝะธะต ะบะปะธะตะฝัะฐ, ะผะพะฝะธัะพัะธะฝะณ changelog |
| ะะตะดะพัััะฟะฝะพััั OpenAI API      | ะกัะตะดะฝัั     | ะกัะตะดะฝะตะต     | Fallback ะฝะฐ ะผะตะฝั ะฑะตะท AI, ะพัะตัะตะดั ัะพะพะฑัะตะฝะธะน    |
| ะัะตะฒััะตะฝะธะต ะปะธะผะธัะพะฒ AmoCRM API   | ะกัะตะดะฝัั     | ะััะพะบะพะต     | Rate limiting, batch-ะทะฐะฟัะพัั, backoff         |
| ะกะฟะฐะผ-ะฐัะฐะบะฐ ะฝะฐ ะฑะพัะฐ              | ะกัะตะดะฝัั     | ะกัะตะดะฝะตะต     | Throttling middleware, ะฑะฐะฝ ะฟะพ telegram_id     |
| ะฃัะตัะบะฐ ัะพะบะตะฝะพะฒ                  | ะะธะทะบะฐั      | ะัะธัะธัะตัะบะพะต | `.env` ะฒะฝะต ัะตะฟะพะทะธัะพัะธั, ัะธััะพะฒะฐะฝะธะต ะฒ ะะ       |
| ะะพะปัะทะพะฒะฐัะตะปั ยซะทะฐัััะตะฒะฐะตัยป ะฒ FSM | ะกัะตะดะฝัั     | ะะธะทะบะพะต      | ะขะฐะนะผะฐัั ัะตััะธะธ (30 ะผะธะฝ), ะบะฝะพะฟะบะฐ ยซะ ะฝะฐัะฐะปะพยป    |

---

## 11. ะะปะพััะฐัะธะน

| ะขะตัะผะธะฝ            | ะะฟัะตะดะตะปะตะฝะธะต                                                           |
| ----------------- | --------------------------------------------------------------------- |
| **FSM**           | Finite State Machine โ ะบะพะฝะตัะฝัะน ะฐะฒัะพะผะฐั ะดะปั ัะฟัะฐะฒะปะตะฝะธั ัะฐะณะฐะผะธ ะดะธะฐะปะพะณะฐ |
| **Intent**        | ะะฐะผะตัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั, ะพะฟัะตะดะตะปัะฝะฝะพะต AI-ะผะพะดัะปะตะผ                       |
| **ะะธะด**           | ะะพัะตะฝัะธะฐะปัะฝัะน ะบะปะธะตะฝั / ะพะฑัะฐัะตะฝะธะต, ะฟะตัะตะดะฐะฝะฝะพะต ะฒ CRM                    |
| **ะะพัะพะฝะบะฐ**       | Pipeline ะฒ AmoCRM โ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพััั ััะฐะฟะพะฒ ัะดะตะปะบะธ                  |
| **callback_data** | ะะฐะฝะฝัะต, ะฟัะธะฒัะทะฐะฝะฝัะต ะบ InlineKeyboard-ะบะฝะพะฟะบะต ะฒ Telegram                |
| **Backoff**       | ะกััะฐัะตะณะธั ะฟะพะฒัะพัะฝัั ะทะฐะฟัะพัะพะฒ ั ัะฒะตะปะธัะธะฒะฐััะธะผะธัั ะธะฝัะตัะฒะฐะปะฐะผะธ           |

---

## 12. ะัะธัะตัะธะธ ะฟัะธัะผะบะธ (Definition of Done)

- [ ] ะะพั ะพัะฒะตัะฐะตั ะฝะฐ `/start` ะธ ะฟะพะบะฐะทัะฒะฐะตั ะณะปะฐะฒะฝะพะต ะผะตะฝั
- [ ] ะัะต 5 ะฒะตัะพะบ ะพะฟัะพัะฐ ัะฐะฑะพัะฐัั ะพั ะฝะฐัะฐะปะฐ ะดะพ ะบะพะฝัะฐ
- [ ] ะะฐะฒะธะณะฐัะธั ยซะะฐะทะฐะด / ะ ะฝะฐัะฐะปะพ / ะัะพะฟัััะธััยป ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ
- [ ] ะขะตะปะตัะพะฝ ะฒะฐะปะธะดะธััะตััั, ะฟัะธะฝะธะผะฐะตััั ะบะฝะพะฟะบะฐ ยซะะพะดะตะปะธัััั ะบะพะฝัะฐะบัะพะผยป
- [ ] ะญะบัะฐะฝ ะฟะพะดัะฒะตัะถะดะตะฝะธั ะฟะพะบะฐะทัะฒะฐะตั ะฒัะต ัะพะฑัะฐะฝะฝัะต ะดะฐะฝะฝัะต
- [ ] ะกะดะตะปะบะฐ ัะพะทะดะฐัััั ะฒ AmoCRM ั ะฟัะฐะฒะธะปัะฝัะผะธ ะฟะพะปัะผะธ
- [ ] ะะพะฝัะฐะบั ะฝะต ะดัะฑะปะธััะตััั ะฟัะธ ะฟะพะฒัะพัะฝะพะผ ะพะฑัะฐัะตะฝะธะธ
- [ ] ะัะธะผะตัะฐะฝะธะต ะบ ัะดะตะปะบะต ัะพะดะตัะถะธั ะฒัะต ะพัะฒะตัั ะฟะพะปัะทะพะฒะฐัะตะปั
- [ ] AI-ะผะพะดัะปั ะพัะฒะตัะฐะตั ะฝะฐ ัะฒะพะฑะพะดะฝัะน ัะตะบัั ะธ ะฟัะตะดะปะฐะณะฐะตั ะฒะตัะบั
- [ ] ะัะธ ะพัะธะฑะบะต CRM โ ะปะธะด ัะพััะฐะฝัะตััั ะปะพะบะฐะปัะฝะพ ะธ ัะตััะฐะธััั
- [ ] ะะพั ัะฐะฑะพัะฐะตั ะฒ Docker 24/7 ั ะฐะฒัะพะฟะตัะตะทะฐะฟััะบะพะผ
- [ ] Edge-cases ะพะฑัะฐะฑะพัะฐะฝั (ัะผ. ัะตะบะปะธัั ะฒ ัะฐะทะดะตะปะต 9)
